# å®Œæ•´çš„ Agentic RAG ç³»ç»Ÿæ¶æ„æ¢³ç†

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### åˆ†å±‚æ¶æ„è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API å±‚                               â”‚
â”‚  â€¢ REST API ç«¯ç‚¹ (/intelligent-query, /query, /agent)      â”‚
â”‚  â€¢ è¯·æ±‚éªŒè¯å’Œå“åº”æ ¼å¼åŒ–                                      â”‚
â”‚  â€¢ é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº”ç”¨å±‚ (RAGApplication)                    â”‚
â”‚  â€¢ ç»Ÿä¸€çš„å…¥å£ç‚¹å’ŒæœåŠ¡åè°ƒ                                    â”‚
â”‚  â€¢ æ™ºèƒ½æŸ¥è¯¢å’Œä¼ ç»ŸæŸ¥è¯¢æ¥å£                                    â”‚
â”‚  â€¢ å…¼å®¹æ€§å¤„ç†                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æœåŠ¡å±‚ (AgentService)                       â”‚
â”‚  â€¢ æ™ºèƒ½æŸ¥è¯¢å…¥å£ (runIntelligentQuery)                       â”‚
â”‚  â€¢ ä¼ ç»ŸæŸ¥è¯¢å…¼å®¹ (runQuery)                                  â”‚
â”‚  â€¢ æµå¼æŸ¥è¯¢å¤„ç†                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               æ™ºèƒ½è·¯ç”±å±‚ (Master Agent)                      â”‚
â”‚  â€¢ æŸ¥è¯¢æ„å›¾åˆ†æ (direct_tool vs knowledge_query)           â”‚
â”‚  â€¢ ç›´æ¥å·¥å…·è°ƒç”¨ (æ•°å­¦ã€å¤©æ°”)                                 â”‚
â”‚  â€¢ çŸ¥è¯†åº“æŸ¥è¯¢è·¯ç”±                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                è·¯ç”±å¼•æ“ (Router Engine)                      â”‚
â”‚  â€¢ å…³é”®è¯åŒ¹é… (ç½®ä¿¡åº¦ > 0.6)                               â”‚
â”‚  â€¢ LLMæ™ºèƒ½åˆ†ç±» (ç½®ä¿¡åº¦ â‰¤ 0.6)                              â”‚
â”‚  â€¢ æ•°æ®é›†é€‰æ‹©å’ŒæŸ¥è¯¢æ‰§è¡Œ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ•°æ®è®¿é—®å±‚ (VectorStoreService)                   â”‚
â”‚  â€¢ Qdrant å‘é‡æ•°æ®åº“è¿æ¥                                    â”‚
â”‚  â€¢ ç´¢å¼•ç®¡ç†å’ŒæŸ¥è¯¢æ‰§è¡Œ                                        â”‚
â”‚  â€¢ å¥åº·æ£€æŸ¥å’Œè¯Šæ–­                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. Master Agent (æ™ºèƒ½å†³ç­–è€…)
- **æ–‡ä»¶ä½ç½®**: `src/services/masterAgent.ts`
- **èŒè´£**: é¡¶å±‚æŸ¥è¯¢æ„å›¾åˆ†æå’Œè·¯ç”±å†³ç­–
- **åŠŸèƒ½**: 
  - åŒºåˆ†ç›´æ¥å·¥å…·è°ƒç”¨ vs çŸ¥è¯†åº“æŸ¥è¯¢
  - å¤„ç†æ•°å­¦è®¡ç®—ã€å¤©æ°”æŸ¥è¯¢ç­‰ç›´æ¥å·¥å…·
  - å°†çŸ¥è¯†åº“æŸ¥è¯¢è½¬å‘ç»™ Router Engine

### 2. Router Engine (æ™ºèƒ½è·¯ç”±å¼•æ“)
- **æ–‡ä»¶ä½ç½®**: `src/services/routerEngine.ts`
- **èŒè´£**: æ•°æ®é›†é€‰æ‹©å’ŒæŸ¥è¯¢æ‰§è¡Œ
- **å†³ç­–æµç¨‹**:
  1. å…³é”®è¯åŒ¹é… (ç½®ä¿¡åº¦ > 0.6 â†’ ç›´æ¥ä½¿ç”¨)
  2. LLMæ™ºèƒ½åˆ†ç±» (ç½®ä¿¡åº¦ â‰¤ 0.6 â†’ LLMåˆ¤æ–­)
  3. å®¹é”™å¤„ç† (LLMå¼‚å¸¸ â†’ é»˜è®¤æ•°æ®é›†)

### 3. LLM Classifier (LLMåˆ†ç±»å™¨)
- **æ–‡ä»¶ä½ç½®**: `src/services/llmClassifier.ts`
- **èŒè´£**: å¤„ç†å…³é”®è¯åŒ¹é…æ— æ³•è§£å†³çš„å¤æ‚æŸ¥è¯¢
- **å·¥ä½œæ–¹å¼**: æä¾›æŸ¥è¯¢å’Œæ•°æ®é›†æè¿°ç»™LLMï¼Œè·å–åˆ†ç±»ç»“æœ
- **è¾“å‡º**: æ¨èæ•°æ®é›† + ç½®ä¿¡åº¦ + æ¨ç†è¿‡ç¨‹

## ğŸ“‹ å…·ä½“ä¾‹å­ï¼šå…¨é“¾è·¯å¤„ç†æ¼”ç¤º

### ä¾‹å­: "åº”è¯¥ä»¥ä»€ä¹ˆåŸåˆ™åˆ’åˆ† dev set å’Œ test set"

#### 1. API å±‚æ¥æ”¶è¯·æ±‚
```http
POST /intelligent-query
Content-Type: application/json
{
  "query": "åº”è¯¥ä»¥ä»€ä¹ˆåŸåˆ™åˆ’åˆ† dev set å’Œ test set"
}
```

#### 2. åº”ç”¨å±‚å¤„ç†
```typescript
// src/app.ts:111
async intelligentQuery(query: string) {
  return await this.agentService.runIntelligentQuery(query);
}
```

#### 3. æœåŠ¡å±‚è°ƒç”¨
```typescript
// src/services/agentService.ts:37
async runIntelligentQuery(query: string): Promise<MasterAgentResponse> {
  return await this.masterAgent.processQuery(query);
}
```

#### 4. Master Agent åˆ†æ
```typescript
// src/services/masterAgent.ts:33
async processQuery(query: string): Promise<MasterAgentResponse> {
  // 1. åˆ†ææŸ¥è¯¢æ„å›¾
  const analysis = await this.analyzeQueryIntent(query);
  // ç»“æœ: {
  //   queryType: 'knowledge_query',
  //   confidence: 0.5,
  //   reasoning: 'æ— æ³•æ˜ç¡®è¯†åˆ«æŸ¥è¯¢ç±»å‹ï¼Œé»˜è®¤ä½œä¸ºçŸ¥è¯†åº“æŸ¥è¯¢å¤„ç†'
  // }
  
  // 2. çŸ¥è¯†åº“æŸ¥è¯¢è·¯ç”±
  const routingResult = await this.routerEngine.routeQuery(query, analysis.domain);
}
```

#### 5. Router Engine è·¯ç”±å†³ç­–
```typescript
// src/services/routerEngine.ts:58
private async selectBestDataset(query: string): Promise<DatasetSelection> {
  // 1. å…³é”®è¯åŒ¹é…
  const mlScore = this.calculateKeywordScore(lowerQuery, mlKeywords);
  const priceScore = this.calculateKeywordScore(lowerQuery, priceIndexKeywords);
  
  // mlScore: 0.35 (åŒ¹é… "dev set", "test set")
  // priceScore: 0.0
  // bestScore: 0.35
  
  // 2. ç½®ä¿¡åº¦åˆ¤æ–­ (0.35 â‰¤ 0.6)
  if (bestScore > 0.6) {
    // è·³è¿‡ - ç½®ä¿¡åº¦ä¸å¤Ÿ
  }
  
  // 3. LLMæ™ºèƒ½åˆ†ç±»
  const llmResult = await this.llmClassifier.classify(query);
  // ç»“æœ: {
  //   dataset: 'machine_learning',
  //   confidence: 0.9,
  //   reasoning: 'æŸ¥è¯¢æ¶‰åŠdev setå’Œtest setçš„åˆ’åˆ†åŸåˆ™ï¼Œå±äºæœºå™¨å­¦ä¹ é¢†åŸŸ'
  // }
}
```

#### 6. LLMåˆ†ç±»å™¨å¤„ç†
```typescript
// src/services/llmClassifier.ts:35
async classify(query: string): Promise<LLMClassificationResult> {
  const prompt = `
  è¯·åˆ†æä»¥ä¸‹æŸ¥è¯¢å¹¶é€‰æ‹©æœ€åˆé€‚çš„æ•°æ®é›†ï¼š
  
  æŸ¥è¯¢: "åº”è¯¥ä»¥ä»€ä¹ˆåŸåˆ™åˆ’åˆ† dev set å’Œ test set"
  
  å¯ç”¨æ•°æ®é›†:
  1. machine_learning: æœºå™¨å­¦ä¹ è¯¾ç¨‹å†…å®¹...
  2. price_index_statistics: ä»·æ ¼æŒ‡æ•°ç»Ÿè®¡æ•°æ®...
  `;
  
  const response = await Settings.llm.complete({ prompt });
  // LLMè¿”å›: {"dataset": "machine_learning", "confidence": 0.9, "reasoning": "..."}
}
```

#### 7. æ•°æ®è®¿é—®å±‚æŸ¥è¯¢
```typescript
// src/services/routerEngine.ts:185
private async executeQuery(query: string, dataset: DatasetKey): Promise<string> {
  const index = await this.vectorStoreService.getIndex('machine_learning');
  const queryEngine = index.asQueryEngine({
    retriever: index.asRetriever({ similarityTopK: 5 }),
  });
  
  const response = await queryEngine.query({ query });
  return response.toString();
}
```

#### 8. æœ€ç»ˆå“åº”
```json
{
  "success": true,
  "data": {
    "query": "åº”è¯¥ä»¥ä»€ä¹ˆåŸåˆ™åˆ’åˆ† dev set å’Œ test set",
    "response": "åœ¨åˆ’åˆ† dev set å’Œ test set æ—¶ï¼Œåº”è¯¥éµå¾ªä»¥ä¸‹åŸåˆ™...",
    "analysis": {
      "queryType": "knowledge_query",
      "confidence": 0.5,
      "reasoning": "æ— æ³•æ˜ç¡®è¯†åˆ«æŸ¥è¯¢ç±»å‹ï¼Œé»˜è®¤ä½œä¸ºçŸ¥è¯†åº“æŸ¥è¯¢å¤„ç†"
    },
    "selectedDataset": "æœºå™¨å­¦ä¹ è¯¾ç¨‹å†…å®¹",
    "routingReason": "LLMæ™ºèƒ½åˆ†ç±»: æŸ¥è¯¢æ¶‰åŠdev setå’Œtest setçš„åˆ’åˆ†åŸåˆ™ï¼Œå±äºæœºå™¨å­¦ä¹ é¢†åŸŸ"
  },
  "meta": {
    "type": "intelligent",
    "routing": {
      "queryType": "knowledge_query",
      "confidence": 0.5,
      "reasoning": "æ— æ³•æ˜ç¡®è¯†åˆ«æŸ¥è¯¢ç±»å‹ï¼Œé»˜è®¤ä½œä¸ºçŸ¥è¯†åº“æŸ¥è¯¢å¤„ç†"
    }
  }
}
```

## ğŸ¯ å…³é”®ç‰¹æ€§

1. **æ™ºèƒ½è·¯ç”±**: è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ•°æ®é›†ï¼Œæ— éœ€ç”¨æˆ·æŒ‡å®š
2. **åˆ†å±‚å†³ç­–**: å…³é”®è¯åŒ¹é… â†’ LLMåˆ†ç±» â†’ å®¹é”™å¤„ç†
3. **é«˜æ€§èƒ½**: é«˜ç½®ä¿¡åº¦æŸ¥è¯¢å¿«é€Ÿè¿”å›
4. **å®¹é”™æœºåˆ¶**: å¤šå±‚æ¬¡çš„é”™è¯¯å¤„ç†å’Œå›é€€ç­–ç•¥
5. **å¯æ‰©å±•æ€§**: æ–°å¢æ•°æ®é›†åªéœ€æ›´æ–°é…ç½®å’ŒLLMæè¿°

## ğŸ’¡ æ”¹è¿›æˆæœ

### è§£å†³çš„é—®é¢˜
- âœ… ä¿®å¤äº†æ„å›¾è¯†åˆ«ä¸å‡†ç¡®çš„é—®é¢˜
- âœ… æ‰©å±•äº†å…³é”®è¯åº“ï¼ŒåŒ…å« "dev set", "test set" ç­‰ä¸“ä¸šæœ¯è¯­
- âœ… å®ç°äº†LLMæ™ºèƒ½åˆ†ç±»ä½œä¸ºå…³é”®è¯åŒ¹é…çš„è¡¥å……
- âœ… ç®€åŒ–äº†å†³ç­–æµç¨‹ï¼Œæé«˜äº†ç³»ç»Ÿç¨³å®šæ€§

### æµ‹è¯•ç»“æœ
- âœ… "åº”è¯¥ä»¥ä»€ä¹ˆåŸåˆ™åˆ’åˆ† dev set å’Œ test set" â†’ æœºå™¨å­¦ä¹ æ•°æ®é›† (LLMåˆ†ç±»)
- âœ… "ä»€ä¹ˆæ˜¯æ¢¯åº¦ä¸‹é™ï¼Ÿ" â†’ æœºå™¨å­¦ä¹ æ•°æ®é›† (å…³é”®è¯åŒ¹é…)
- âœ… "æœ€è¿‘ä¸€ä¸ªæœˆPPIæ˜¯å¤šå°‘ï¼Ÿ" â†’ ä»·æ ¼æŒ‡æ•°æ•°æ®é›† (å…³é”®è¯åŒ¹é…)
- âœ… "å¦‚ä½•è¯„ä¼°ä¸€ä¸ªAIæ¨¡å‹çš„æ€§èƒ½ï¼Ÿ" â†’ æœºå™¨å­¦ä¹ æ•°æ®é›† (å…³é”®è¯åŒ¹é…)

## ğŸ”„ å†³ç­–æµç¨‹å›¾

```
ç”¨æˆ·æŸ¥è¯¢
    â†“
Master Agent æ„å›¾åˆ†æ
    â†“
ç›´æ¥å·¥å…·è°ƒç”¨? â†’ æ˜¯ â†’ æ•°å­¦/å¤©æ°”å·¥å…· â†’ è¿”å›ç»“æœ
    â†“ å¦
Router Engine è·¯ç”±
    â†“
å…³é”®è¯åŒ¹é… â†’ ç½®ä¿¡åº¦ > 0.6? â†’ æ˜¯ â†’ é€‰æ‹©æ•°æ®é›†
    â†“ å¦
LLMæ™ºèƒ½åˆ†ç±» â†’ æˆåŠŸ? â†’ æ˜¯ â†’ é€‰æ‹©æ•°æ®é›†
    â†“ å¦
é»˜è®¤æ•°æ®é›† (å®¹é”™)
    â†“
æ‰§è¡ŒæŸ¥è¯¢ â†’ è¿”å›ç»“æœ
```

è¿™å°±æ˜¯æ”¹è¿›åçš„å®Œæ•´ Agentic RAG ç³»ç»Ÿæ¶æ„ï¼